generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
}

model User {
  id                   String                @id @default(cuid())
  email                String                @unique
  password             String
  firstName            String
  lastName             String
  role                 UserRole              @default(SALES_REP)
  isActive             Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  appointments         Appointment[]
  calls                Call[]
  campaignExecutions   CampaignExecution[]
  campaigns            Campaign[]
  customers            Customer[]
  emergencyCalls       EmergencyCall[]       @relation("EmergencyCallHandler")
  leads                Lead[]
  receivedMessages     Message[]             @relation("MessageReceiver")
  sentMessages         Message[]             @relation("MessageSender")
  serviceRequests      ServiceRequest[]      @relation("ServiceRequestAssignee")
  dispatchedServices   ServiceRequest[]      @relation("ServiceRequestDispatcher")
  serviceStatusUpdates ServiceStatusUpdate[]
  tasks                Task[]                @relation("TaskAssignee")
  createdTasks         Task[]                @relation("TaskCreator")

  @@map("users")
}

model Customer {
  id                 String              @id @default(cuid())
  firstName          String
  lastName           String
  email              String?             @unique
  phone              String?
  address            String?
  city               String?
  state              String?
  zipCode            String?
  dateOfBirth        DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  assignedToId       String?
  appointments       Appointment[]
  calls              Call[]
  campaignExecutions CampaignExecution[]
  assignedTo         User?               @relation(fields: [assignedToId], references: [id])
  emergencyCalls     EmergencyCall[]
  leads              Lead[]
  messages           Message[]
  serviceRequests    ServiceRequest[]
  serviceReviews     ServiceReview[]
  tasks              Task[]
  vehicles           Vehicle[]

  @@map("customers")
}

model Vehicle {
  id              String           @id @default(cuid())
  vin             String           @unique
  make            String
  model           String
  year            Int
  color           String?
  mileage         Int?
  price           Decimal?
  status          VehicleStatus    @default(AVAILABLE)
  description     String?
  features        String[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  customerId      String?
  appointments    Appointment[]
  emergencyCalls  EmergencyCall[]
  leads           Lead[]
  serviceRequests ServiceRequest[]
  customer        Customer?        @relation(fields: [customerId], references: [id])

  @@map("vehicles")
}

model Lead {
  id                 String              @id @default(cuid())
  source             LeadSource
  status             LeadStatus          @default(NEW)
  priority           Priority            @default(MEDIUM)
  notes              String?
  followUpDate       DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  customerId         String
  assignedToId       String?
  vehicleId          String?
  calls              Call[]
  campaignExecutions CampaignExecution[]
  assignedTo         User?               @relation(fields: [assignedToId], references: [id])
  customer           Customer            @relation(fields: [customerId], references: [id])
  vehicle            Vehicle?            @relation(fields: [vehicleId], references: [id])
  messages           Message[]
  tasks              Task[]

  @@map("leads")
}

model Call {
  id          String        @id @default(cuid())
  direction   CallDirection
  status      CallStatus    @default(INITIATED)
  duration    Int?
  recording   String?
  transcript  String?
  summary     String?
  sentiment   String?
  outcome     String?
  notes       String?
  scheduledAt DateTime?
  startedAt   DateTime?
  endedAt     DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  customerId  String
  agentId     String?
  leadId      String?
  agent       User?         @relation(fields: [agentId], references: [id])
  customer    Customer      @relation(fields: [customerId], references: [id])
  lead        Lead?         @relation(fields: [leadId], references: [id])

  @@map("calls")
}

model Appointment {
  id                 String              @id @default(cuid())
  title              String
  description        String?
  type               AppointmentType
  status             AppointmentStatus   @default(SCHEDULED)
  startTime          DateTime
  endTime            DateTime
  duration           Int
  location           String?
  notes              String?
  reminderSent       Boolean             @default(false)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  customerId         String
  assignedToId       String?
  vehicleId          String?
  assignedTo         User?               @relation(fields: [assignedToId], references: [id])
  customer           Customer            @relation(fields: [customerId], references: [id])
  vehicle            Vehicle?            @relation(fields: [vehicleId], references: [id])
  campaignExecutions CampaignExecution[]
  messages           Message[]
  tasks              Task[]

  @@map("appointments")
}

model Message {
  id               String           @id @default(cuid())
  type             MessageType
  channel          MessageChannel
  subject          String?
  content          String
  status           MessageStatus    @default(PENDING)
  direction        MessageDirection
  externalId       String?
  metadata         Json?
  readAt           DateTime?
  deliveredAt      DateTime?
  failedAt         DateTime?
  errorMessage     String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  senderId         String?
  receiverId       String?
  customerId       String
  leadId           String?
  appointmentId    String?
  taskId           String?
  serviceRequestId String?
  appointment      Appointment?     @relation(fields: [appointmentId], references: [id])
  customer         Customer         @relation(fields: [customerId], references: [id])
  lead             Lead?            @relation(fields: [leadId], references: [id])
  receiver         User?            @relation("MessageReceiver", fields: [receiverId], references: [id])
  sender           User?            @relation("MessageSender", fields: [senderId], references: [id])
  serviceRequest   ServiceRequest?  @relation(fields: [serviceRequestId], references: [id])
  task             Task?            @relation(fields: [taskId], references: [id])

  @@map("messages")
}

model Task {
  id               String          @id @default(cuid())
  title            String
  description      String?
  type             TaskType
  priority         TaskPriority    @default(MEDIUM)
  status           TaskStatus      @default(PENDING)
  dueDate          DateTime?
  completedAt      DateTime?
  isAutomated      Boolean         @default(false)
  triggerType      String?
  triggerData      Json?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  assigneeId       String?
  creatorId        String
  customerId       String
  leadId           String?
  appointmentId    String?
  parentTaskId     String?
  serviceRequestId String?
  messages         Message[]
  appointment      Appointment?    @relation(fields: [appointmentId], references: [id])
  assignee         User?           @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creator          User            @relation("TaskCreator", fields: [creatorId], references: [id])
  customer         Customer        @relation(fields: [customerId], references: [id])
  lead             Lead?           @relation(fields: [leadId], references: [id])
  parentTask       Task?           @relation("TaskHierarchy", fields: [parentTaskId], references: [id])
  subtasks         Task[]          @relation("TaskHierarchy")
  serviceRequest   ServiceRequest? @relation(fields: [serviceRequestId], references: [id])

  @@map("tasks")
}

model Campaign {
  id                String              @id @default(cuid())
  name              String
  description       String?
  type              CampaignType
  status            CampaignStatus      @default(DRAFT)
  triggerEvent      String
  triggerConditions Json?
  isActive          Boolean             @default(false)
  startDate         DateTime?
  endDate           DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  creatorId         String
  executions        CampaignExecution[]
  steps             CampaignStep[]
  creator           User                @relation(fields: [creatorId], references: [id])

  @@map("campaigns")
}

model CampaignStep {
  id         String                  @id @default(cuid())
  order      Int
  name       String
  type       CampaignStepType
  delayDays  Int                     @default(0)
  delayHours Int                     @default(0)
  subject    String?
  content    String
  channel    MessageChannel
  conditions Json?
  createdAt  DateTime                @default(now())
  updatedAt  DateTime                @updatedAt
  campaignId String
  executions CampaignStepExecution[]
  campaign   Campaign                @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@map("campaign_steps")
}

model CampaignExecution {
  id             String                  @id @default(cuid())
  status         CampaignExecutionStatus @default(ACTIVE)
  startedAt      DateTime                @default(now())
  completedAt    DateTime?
  pausedAt       DateTime?
  triggerData    Json?
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  campaignId     String
  customerId     String
  executorId     String
  leadId         String?
  appointmentId  String?
  appointment    Appointment?            @relation(fields: [appointmentId], references: [id])
  campaign       Campaign                @relation(fields: [campaignId], references: [id])
  customer       Customer                @relation(fields: [customerId], references: [id])
  executor       User                    @relation(fields: [executorId], references: [id])
  lead           Lead?                   @relation(fields: [leadId], references: [id])
  stepExecutions CampaignStepExecution[]

  @@map("campaign_executions")
}

model CampaignStepExecution {
  id           String                      @id @default(cuid())
  status       CampaignStepExecutionStatus @default(PENDING)
  scheduledAt  DateTime
  executedAt   DateTime?
  failedAt     DateTime?
  errorMessage String?
  messageId    String?
  taskId       String?
  createdAt    DateTime                    @default(now())
  updatedAt    DateTime                    @updatedAt
  executionId  String
  stepId       String
  execution    CampaignExecution           @relation(fields: [executionId], references: [id], onDelete: Cascade)
  step         CampaignStep                @relation(fields: [stepId], references: [id])

  @@map("campaign_step_executions")
}

model EmergencyCall {
  id               String              @id @default(cuid())
  callType         EmergencyCallType
  priority         EmergencyPriority   @default(MEDIUM)
  status           EmergencyCallStatus @default(RECEIVED)
  latitude         Float?
  longitude        Float?
  address          String?
  landmark         String?
  description      String
  symptoms         String?
  vehicleInfo      String?
  receivedAt       DateTime            @default(now())
  dispatchedAt     DateTime?
  arrivedAt        DateTime?
  completedAt      DateTime?
  estimatedArrival DateTime?
  actualArrival    DateTime?
  notes            String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  customerId       String
  vehicleId        String?
  handlerId        String?
  customer         Customer            @relation(fields: [customerId], references: [id])
  handler          User?               @relation("EmergencyCallHandler", fields: [handlerId], references: [id])
  vehicle          Vehicle?            @relation(fields: [vehicleId], references: [id])
  serviceRequest   ServiceRequest?

  @@map("emergency_calls")
}

model ServiceProvider {
  id               String              @id @default(cuid())
  name             String
  type             ServiceProviderType
  phone            String
  email            String?
  address          String
  city             String
  state            String
  zipCode          String
  serviceRadius    Float
  latitude         Float
  longitude        Float
  services         ServiceType[]
  isActive         Boolean             @default(true)
  isAvailable      Boolean             @default(true)
  hoursOfOperation Json?
  averageRating    Float?
  totalJobs        Int                 @default(0)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  serviceRequests  ServiceRequest[]
  reviews          ServiceReview[]

  @@map("service_providers")
}

model ServiceRequest {
  id                String                @id @default(cuid())
  requestNumber     String                @unique
  type              ServiceType
  priority          ServicePriority       @default(MEDIUM)
  status            ServiceRequestStatus  @default(PENDING)
  latitude          Float
  longitude         Float
  address           String
  description       String
  symptoms          String?
  vehicleInfo       String?
  requestedAt       DateTime              @default(now())
  scheduledAt       DateTime?
  dispatchedAt      DateTime?
  arrivedAt         DateTime?
  startedAt         DateTime?
  completedAt       DateTime?
  estimatedCost     Float?
  actualCost        Float?
  billableHours     Float?
  workPerformed     String?
  partsUsed         String?
  notes             String?
  customerRating    Int?
  customerFeedback  String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  customerId        String
  vehicleId         String?
  emergencyCallId   String?               @unique
  serviceProviderId String?
  assignedToId      String?
  dispatcherId      String?
  messages          Message[]
  assignedTo        User?                 @relation("ServiceRequestAssignee", fields: [assignedToId], references: [id])
  customer          Customer              @relation(fields: [customerId], references: [id])
  dispatcher        User?                 @relation("ServiceRequestDispatcher", fields: [dispatcherId], references: [id])
  emergencyCall     EmergencyCall?        @relation(fields: [emergencyCallId], references: [id])
  serviceProvider   ServiceProvider?      @relation(fields: [serviceProviderId], references: [id])
  vehicle           Vehicle?              @relation(fields: [vehicleId], references: [id])
  reviews           ServiceReview[]
  statusUpdates     ServiceStatusUpdate[]
  tasks             Task[]

  @@map("service_requests")
}

model ServiceStatusUpdate {
  id               String               @id @default(cuid())
  status           ServiceRequestStatus
  message          String
  location         String?
  latitude         Float?
  longitude        Float?
  estimatedArrival DateTime?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  serviceRequestId String
  updatedById      String?
  serviceRequest   ServiceRequest       @relation(fields: [serviceRequestId], references: [id], onDelete: Cascade)
  updatedBy        User?                @relation(fields: [updatedById], references: [id])

  @@map("service_status_updates")
}

model ServiceReview {
  id                String          @id @default(cuid())
  rating            Int
  comment           String?
  timeliness        Int?
  quality           Int?
  professionalism   Int?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  serviceProviderId String
  customerId        String
  serviceRequestId  String?
  customer          Customer        @relation(fields: [customerId], references: [id])
  serviceProvider   ServiceProvider @relation(fields: [serviceProviderId], references: [id])
  serviceRequest    ServiceRequest? @relation(fields: [serviceRequestId], references: [id])

  @@map("service_reviews")
}

enum UserRole {
  ADMIN
  MANAGER
  SALES_REP
  SUPPORT
}

enum VehicleStatus {
  AVAILABLE
  SOLD
  RESERVED
  MAINTENANCE
}

enum LeadSource {
  WEBSITE
  PHONE_CALL
  EMAIL
  REFERRAL
  WALK_IN
  SOCIAL_MEDIA
  ADVERTISEMENT
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL_SENT
  NEGOTIATING
  CLOSED_WON
  CLOSED_LOST
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum CallDirection {
  INBOUND
  OUTBOUND
}

enum CallStatus {
  INITIATED
  RINGING
  ANSWERED
  COMPLETED
  FAILED
  BUSY
  NO_ANSWER
}

enum AppointmentType {
  SALES_CONSULTATION
  TEST_DRIVE
  VEHICLE_DELIVERY
  SERVICE_APPOINTMENT
  FINANCING_MEETING
  TRADE_IN_APPRAISAL
  FOLLOW_UP_MEETING
  PHONE_CONSULTATION
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
  RESCHEDULED
}

enum MessageType {
  EMAIL
  SMS
  CHAT
  SYSTEM_NOTIFICATION
  CAMPAIGN_MESSAGE
}

enum MessageChannel {
  EMAIL
  SMS
  CHAT
  WHATSAPP
  PHONE
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
  BOUNCED
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum TaskType {
  FOLLOW_UP_CALL
  SEND_EMAIL
  SEND_SMS
  SCHEDULE_APPOINTMENT
  PREPARE_DOCUMENTS
  VEHICLE_INSPECTION
  CUSTOMER_RESEARCH
  LEAD_QUALIFICATION
  CUSTOM
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  OVERDUE
}

enum CampaignType {
  LEAD_NURTURING
  FOLLOW_UP_SEQUENCE
  APPOINTMENT_REMINDERS
  POST_SALE_FOLLOW_UP
  RE_ENGAGEMENT
  PROMOTIONAL
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

enum CampaignStepType {
  SEND_EMAIL
  SEND_SMS
  CREATE_TASK
  WAIT
  CONDITIONAL
}

enum CampaignExecutionStatus {
  ACTIVE
  COMPLETED
  PAUSED
  FAILED
  CANCELLED
}

enum CampaignStepExecutionStatus {
  PENDING
  EXECUTING
  COMPLETED
  FAILED
  SKIPPED
}

enum EmergencyCallType {
  BREAKDOWN
  ACCIDENT
  FLAT_TIRE
  DEAD_BATTERY
  LOCKOUT
  OUT_OF_FUEL
  OVERHEATING
  TOWING_REQUEST
  MECHANICAL_ISSUE
  OTHER
}

enum EmergencyPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
  LIFE_THREATENING
}

enum EmergencyCallStatus {
  RECEIVED
  TRIAGED
  DISPATCHED
  EN_ROUTE
  ARRIVED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  FAILED
}

enum ServiceProviderType {
  TOWING_COMPANY
  MOBILE_MECHANIC
  TIRE_SERVICE
  LOCKSMITH
  FUEL_DELIVERY
  BATTERY_SERVICE
  GENERAL_ROADSIDE
  EMERGENCY_RESPONSE
}

enum ServiceType {
  TOWING
  JUMP_START
  TIRE_CHANGE
  LOCKOUT_SERVICE
  FUEL_DELIVERY
  MECHANICAL_REPAIR
  WINCH_OUT
  BATTERY_REPLACEMENT
  EMERGENCY_REPAIR
  ACCIDENT_ASSISTANCE
}

enum ServicePriority {
  LOW
  MEDIUM
  HIGH
  EMERGENCY
}

enum ServiceRequestStatus {
  PENDING
  ASSIGNED
  DISPATCHED
  EN_ROUTE
  ARRIVED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  FAILED
  REQUIRES_FOLLOWUP
}

// Outbound Calling Enums
enum OutboundCampaignType {
  APPOINTMENT_REMINDER
  SERVICE_FOLLOWUP
  SALES_OUTREACH
  CUSTOMER_SATISFACTION
  PAYMENT_REMINDER
  GENERAL
  LEAD_QUALIFICATION
  EVENT_INVITATION
  SURVEY
  RECALL_NOTIFICATION
}

enum OutboundCampaignStatus {
  PENDING
  RUNNING
  PAUSED
  COMPLETED
  STOPPED
  FAILED
}

enum OutboundCallStatus {
  INITIATED
  RINGING
  ANSWERED
  IN_PROGRESS
  COMPLETED
  FAILED
  NO_ANSWER
  BUSY
  VOICEMAIL
  CANCELLED
}

enum OutboundCallOutcome {
  HUMAN_ANSWERED
  VOICEMAIL_LEFT
  VOICEMAIL_FULL
  NO_ANSWER
  BUSY
  FAILED
  WRONG_NUMBER
  DO_NOT_CALL
  APPOINTMENT_SCHEDULED
  CALLBACK_REQUESTED
  INFORMATION_PROVIDED
  NOT_INTERESTED
}


// ============================================
// OUTBOUND CALLING MODELS
// ============================================

model OutboundCampaign {
  id          String   @id @default(cuid())
  name        String
  type        OutboundCampaignType
  dealershipId String?
  googleSheetId String?
  status      OutboundCampaignStatus @default(PENDING)

  // Campaign metrics
  totalContacts    Int @default(0)
  contactsCalled   Int @default(0)
  contactsCompleted Int @default(0)
  contactsFailed   Int @default(0)

  // Timing
  startedAt    DateTime?
  completedAt  DateTime?
  scheduledTime DateTime?

  // Settings stored as JSON
  // { delayBetweenCalls, callDuringHours, maxAttemptsPerContact, recordCalls }
  settings     Json?

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  calls OutboundCall[]

  @@map("outbound_campaigns")
}

model OutboundCall {
  id          String   @id @default(cuid())
  callSid     String   @unique

  // Customer information
  customerName  String
  customerPhone String
  customerEmail String?

  // Call status
  status      OutboundCallStatus @default(INITIATED)
  direction   String   @default("OUTBOUND")

  // Timing
  initiatedAt DateTime @default(now())
  answeredAt  DateTime?
  completedAt DateTime?

  // Call details
  duration    Int?     // in seconds
  answeredBy  String?  // human, machine_start, machine_end_beep, machine_end_silence, machine_end_other, fax, unknown

  // Recording
  recordingUrl String?
  recordingSid String?
  recordingDuration Int?

  // AI conversation
  transcript  String?  @db.Text
  outcome     OutboundCallOutcome?
  notes       String?  @db.Text

  // Campaign relation
  campaign    OutboundCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  campaignId  String?

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("outbound_calls")
  @@index([campaignId])
  @@index([customerPhone])
  @@index([status])
  @@index([initiatedAt])
}
